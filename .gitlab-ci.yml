# GitLab CI/CD è¨­å®šæª”
# é€™å€‹æª”æ¡ˆå®šç¾©äº†è‡ªå‹•åŒ–å»ºç½®å’Œæ¸¬è©¦æµç¨‹

# ä½¿ç”¨ .NET 8.0 SDK çš„ Docker æ˜ åƒæª”
image: mcr.microsoft.com/dotnet/sdk:8.0

# å®šç¾© CI/CD çš„éšæ®µï¼ˆæŒ‰é †åºåŸ·è¡Œï¼‰
stages:
  - build    # ç¬¬ä¸€éšæ®µï¼šç·¨è­¯
  - test     # ç¬¬äºŒéšæ®µï¼šæ¸¬è©¦

# å…¨åŸŸè®Šæ•¸
variables:
  # è¨­å®š NuGet å¥—ä»¶å¿«å–è·¯å¾‘ï¼ˆåŠ é€Ÿå»ºç½®ï¼‰
  NUGET_PACKAGES_DIRECTORY: '.nuget'
  # è¨­å®šå»ºç½®çµ„æ…‹ç‚º Release
  BUILD_CONFIGURATION: 'Release'

# å¿«å–è¨­å®šï¼ˆåŠ é€Ÿå¾ŒçºŒå»ºç½®ï¼‰
cache:
  paths:
    - .nuget/

# åœ¨æ¯å€‹ job åŸ·è¡Œå‰çš„æº–å‚™å·¥ä½œ
before_script:
  - echo "ğŸš€ é–‹å§‹ CI/CD æµç¨‹"
  - dotnet --version
  - echo "å°ˆæ¡ˆè·¯å¾‘ï¼š$CI_PROJECT_DIR"

# ==================== Build éšæ®µ ====================
# Job 1ï¼šç·¨è­¯å°ˆæ¡ˆ
build_job:
  stage: build
  script:
    - echo "ğŸ“¦ é–‹å§‹é‚„åŸ NuGet å¥—ä»¶..."
    - dotnet restore
    - echo "ğŸ”¨ é–‹å§‹ç·¨è­¯å°ˆæ¡ˆ..."
    - dotnet build --configuration $BUILD_CONFIGURATION --no-restore
    - echo "âœ… ç·¨è­¯å®Œæˆï¼"
  # ä¿ç•™ç·¨è­¯ç”¢ç‰©ï¼Œä¾›å¾ŒçºŒéšæ®µä½¿ç”¨
  artifacts:
    paths:
      - bin/$BUILD_CONFIGURATION/
      - obj/
    expire_in: 1 hour
  # åªåœ¨ main åˆ†æ”¯å’Œ merge request æ™‚åŸ·è¡Œ
  only:
    - main
    - merge_requests
    - tags

# ==================== Test éšæ®µ ====================
# Job 2ï¼šåŸ·è¡Œæ¸¬è©¦
test_job:
  stage: test
  script:
    - echo "ğŸ§ª é–‹å§‹åŸ·è¡Œæ¸¬è©¦..."
    # æª¢æŸ¥æ˜¯å¦æœ‰æ¸¬è©¦å°ˆæ¡ˆ
    - |
      if [ -d "PXPayBackend.Tests" ]; then
        echo "æ‰¾åˆ°æ¸¬è©¦å°ˆæ¡ˆï¼Œé–‹å§‹åŸ·è¡Œæ¸¬è©¦..."
        dotnet test --no-restore --verbosity normal --configuration $BUILD_CONFIGURATION
      else
        echo "âš ï¸  ç›®å‰æ²’æœ‰æ¸¬è©¦å°ˆæ¡ˆï¼Œè·³éæ¸¬è©¦éšæ®µ"
        echo "å»ºè­°ï¼šæœªä¾†å¯ä»¥åŠ å…¥å–®å…ƒæ¸¬è©¦ä¾†æå‡ç¨‹å¼ç¢¼å“è³ª"
      fi
    - echo "âœ… æ¸¬è©¦éšæ®µå®Œæˆï¼"
  # ä¾è³´ build_job çš„ç”¢ç‰©
  dependencies:
    - build_job
  # åªåœ¨ main åˆ†æ”¯å’Œ merge request æ™‚åŸ·è¡Œ
  only:
    - main
    - merge_requests
    - tags

# ==================== é¡å¤–ï¼šç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥ ====================
# Job 3ï¼šæª¢æŸ¥ç¨‹å¼ç¢¼æ ¼å¼ï¼ˆå¯é¸ï¼‰
code_quality:
  stage: test
  script:
    - echo "ğŸ” æª¢æŸ¥ç¨‹å¼ç¢¼æ ¼å¼..."
    - dotnet format --verify-no-changes --verbosity diagnostic || echo "âš ï¸  ç¨‹å¼ç¢¼æ ¼å¼éœ€è¦èª¿æ•´"
    - echo "âœ… ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥å®Œæˆï¼"
  dependencies:
    - build_job
  # å…è¨±å¤±æ•—ï¼ˆä¸æœƒé˜»æ“‹ Pipelineï¼‰
  allow_failure: true
  only:
    - main
    - merge_requests

# ==================== æˆåŠŸå¾Œçš„é€šçŸ¥ ====================
after_script:
  - echo "ğŸ‰ CI/CD æµç¨‹çµæŸ"
  - echo "å°ˆæ¡ˆï¼š$CI_PROJECT_NAME"
  - echo "åˆ†æ”¯ï¼š$CI_COMMIT_REF_NAME"
  - echo "æäº¤ï¼š$CI_COMMIT_SHORT_SHA"

