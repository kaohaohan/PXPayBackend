# GitHub Actions CI/CD è¨­å®šæª”
# é€™å€‹æª”æ¡ˆå®šç¾©äº†è‡ªå‹•åŒ–å»ºç½®å’Œæ¸¬è©¦æµç¨‹

name: .NET CI/CD

# è§¸ç™¼æ¢ä»¶
on:
  push:
    branches: [ "main", "master" ]  # ç•¶æ¨é€åˆ° main æˆ– master åˆ†æ”¯æ™‚è§¸ç™¼
  pull_request:
    branches: [ "main", "master" ]  # ç•¶å»ºç«‹ PR åˆ° main æˆ– master æ™‚è§¸ç™¼

# å®šç¾©ç’°å¢ƒè®Šæ•¸
env:
  BUILD_CONFIGURATION: Release

# å®šç¾©å·¥ä½œæµç¨‹
jobs:
  # ==================== Build å’Œ Test ====================
  build-and-test:
    name: å»ºç½®å’Œæ¸¬è©¦
    runs-on: ubuntu-latest  # ä½¿ç”¨ Ubuntu æœ€æ–°ç‰ˆæœ¬

    steps:
    # Step 1ï¼šæª¢å‡ºç¨‹å¼ç¢¼
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4

    # Step 2ï¼šè¨­å®š .NET ç’°å¢ƒ
    - name: ğŸ”§ è¨­å®š .NET 8.0
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    # Step 3ï¼šé¡¯ç¤º .NET ç‰ˆæœ¬
    - name: ğŸ“‹ é¡¯ç¤º .NET ç‰ˆæœ¬
      run: dotnet --version

    # Step 4ï¼šé‚„åŸ NuGet å¥—ä»¶
    - name: ğŸ“¦ é‚„åŸ NuGet å¥—ä»¶
      run: dotnet restore

    # Step 5ï¼šç·¨è­¯å°ˆæ¡ˆ
    - name: ğŸ”¨ ç·¨è­¯å°ˆæ¡ˆ
      run: dotnet build --configuration $BUILD_CONFIGURATION --no-restore

    # Step 6ï¼šåŸ·è¡Œæ¸¬è©¦ï¼ˆå¦‚æœæœ‰æ¸¬è©¦å°ˆæ¡ˆï¼‰
    - name: ğŸ§ª åŸ·è¡Œæ¸¬è©¦
      run: |
        if [ -d "PXPayBackend.Tests" ]; then
          echo "æ‰¾åˆ°æ¸¬è©¦å°ˆæ¡ˆï¼Œé–‹å§‹åŸ·è¡Œæ¸¬è©¦..."
          dotnet test --no-build --configuration $BUILD_CONFIGURATION --verbosity normal
        else
          echo "âš ï¸  ç›®å‰æ²’æœ‰æ¸¬è©¦å°ˆæ¡ˆï¼Œè·³éæ¸¬è©¦éšæ®µ"
        fi

    # Step 7ï¼šç™¼å¸ƒæˆåŠŸè¨Šæ¯
    - name: âœ… å»ºç½®æˆåŠŸ
      if: success()
      run: |
        echo "ğŸ‰ å»ºç½®å’Œæ¸¬è©¦æˆåŠŸï¼"
        echo "å°ˆæ¡ˆï¼š${{ github.repository }}"
        echo "åˆ†æ”¯ï¼š${{ github.ref_name }}"
        echo "æäº¤ï¼š${{ github.sha }}"

